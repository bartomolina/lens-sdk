name: 'Test Workflow'
description: 'Run tests against a specified environment'

inputs:
  environment:
    description: 'Environment to run tests against'
    required: true
    default: 'staging'
  private_key:
    description: 'Private key for authentication'
    required: true
  global_sponsorship:
    description: 'The Global Sponsorship address'
    required: true
  sponsorship_approver_private_key:
    description: 'Private key for a Global Sponsorship Signer'
    required: true
  publish_results:
    description: 'Publish test results'
    required: false
    default: 'false'
  test_app:
    description: 'A valid Lens App address'
    required: true
  test_account:
    description: 'A Lens Account address'
    required: true
  test_erc20:
    description: 'An ERC20 token address'
    required: true
  
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4

    - name: Setup Repository
      uses: ./.github/actions/setup

    - name: Build
      shell: bash
      run: pnpm build

    - name: Setup Environment Variables
      shell: bash
      run: |
        echo "PRIVATE_KEY=${{ inputs.private_key }}" >> .env
        echo "TEST_APP=${{ inputs.test_app }}" >> .env
        echo "TEST_ACCOUNT=${{ inputs.test_account }}" >> .env
        echo "TEST_ERC20=${{ inputs.test_erc20 }}" >> .env
        echo "ENVIRONMENT=${{ inputs.environment }}" >> .env
        echo "GLOBAL_SPONSORSHIP=${{ inputs.environment }}" >> .env
        echo "SPONSORSHIP_APPROVER_PRIVATE_KEY=${{ inputs.sponsorship_approver_private_key }}" >> .env

    - name: Run Tests
      shell: bash
      run: pnpm test

    - name: Publish Test Results
      if: ${{ inputs.publish_results == 'true' }}
      shell: bash
      run: |
        echo "Publishing test results..."
        # Add logic to upload test results to a service or save artifacts
        echo "Test results published."
